# mHost - macOS Host 文件管理工具需求文档

## 1. 项目概述

### 1.1 项目名称
mHost - macOS Host 文件管理工具

### 1.2 项目描述
mHost 是一个专为 macOS 设计的 host 文件管理工具，允许用户通过图形界面轻松管理和切换不同的 host 配置文件。该工具支持创建多个 profile，每个 profile 对应一套独立的 host 配置，用户可以根据不同的开发环境或使用场景快速切换。

### 1.3 技术栈
- **后端核心**: Go 语言
- **UI 框架**: Fyne (跨平台 GUI 框架)
- **目标平台**: macOS
- **权限管理**: 需要管理员权限修改 /etc/hosts 文件

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 Host 文件管理
- 读取当前系统 host 文件 (`/etc/hosts`)
- 备份原始 host 文件
- 修改 host 文件内容
- 恢复 host 文件到原始状态
- 验证 host 文件格式的有效性

#### 2.1.2 Profile 管理
- 创建新的 host profile
- 编辑现有 profile
- 删除 profile
- 重命名 profile
- 导入/导出 profile
- Profile 列表显示和管理

#### 2.1.3 Profile 切换
- 一键切换到指定 profile
- 显示当前激活的 profile
- 切换前自动备份当前配置
- 切换失败时自动回滚

### 2.2 辅助功能

#### 2.2.1 权限管理
- 检测当前用户权限
- 请求管理员权限
- 安全的权限提升机制
- **Helper Tool 持久化权限方案**:
  - 首次启动时安装特权 Helper Tool
  - 后续操作通过 XPC 与 Helper Tool 通信
  - 无需重复请求管理员权限
  - 支持 Helper Tool 的安装、卸载和管理

#### 2.2.2 配置验证
- Host 条目格式验证
- IP 地址格式检查
- 域名格式检查
- 重复条目检测

#### 2.2.3 日志记录
- 操作日志记录
- 错误日志记录
- 切换历史记录

## 3. 用户界面需求

### 3.1 主界面设计

#### 3.1.1 布局结构
- **顶部菜单栏**: 文件、编辑、工具、帮助
- **左侧面板**: Profile 列表
- **右侧面板**: 当前 Profile 内容编辑区
- **底部状态栏**: 当前状态、操作提示

#### 3.1.2 Profile 列表面板
- Profile 名称显示
- 当前激活 Profile 高亮显示
- 右键菜单：编辑、删除、重命名、导出
- 新建 Profile 按钮
- 搜索/过滤功能

#### 3.1.3 编辑面板
- Host 条目列表（表格形式）
  - IP 地址列
  - 域名列
  - 注释列
  - 启用/禁用状态列
- 添加新条目按钮
- 批量操作按钮（启用/禁用/删除）
- 语法高亮显示

### 3.2 对话框设计

#### 3.2.1 新建/编辑 Profile 对话框
- Profile 名称输入
- 描述信息输入
- 基于现有 Profile 创建选项
- 确认/取消按钮

#### 3.2.2 添加/编辑 Host 条目对话框
- IP 地址输入框（带验证）
- 域名输入框（带验证）
- 注释输入框
- 启用状态复选框
- 确认/取消按钮

#### 3.2.3 权限请求对话框
- 权限说明文本
- 安全提示信息
- 授权/取消按钮

### 3.3 菜单设计

#### 3.3.1 文件菜单
- 新建 Profile
- 导入 Profile
- 导出 Profile
- 退出

#### 3.3.2 编辑菜单
- 添加 Host 条目
- 编辑选中条目
- 删除选中条目
- 全选
- 查找替换

#### 3.3.3 工具菜单
- 应用当前 Profile
- 恢复原始 Host 文件
- 验证 Host 文件
- 清理无效条目
- 偏好设置

#### 3.3.4 帮助菜单
- 使用说明
- 关于

## 4. 技术需求

### 4.1 系统要求
- **操作系统**: macOS 10.14 或更高版本
- **架构支持**: Intel x64 和 Apple Silicon (M1/M2)
- **权限**: 需要管理员权限修改系统文件

### 4.2 性能要求
- 应用启动时间 < 3 秒
- Profile 切换时间 < 1 秒
- 支持大型 host 文件（1000+ 条目）
- 内存占用 < 50MB

### 4.3 安全要求
- 权限最小化原则
- 操作前自动备份
- 失败时自动回滚
- 输入数据验证和清理
- 防止恶意 host 条目注入
- **Helper Tool 安全机制**:
  - Helper Tool 只暴露最小必要接口
  - 验证请求来源和参数合法性
  - 记录所有特权操作日志
  - 支持安全卸载机制

### 4.4 兼容性要求
- 兼容标准 hosts 文件格式
- 支持 IPv4 和 IPv6 地址
- 保持与系统 hosts 文件的兼容性
- 支持中文域名（IDN）

## 5. 数据存储需求

### 5.1 Profile 存储
- **存储位置**: `~/Library/Application Support/mHost/profiles/`
- **文件格式**: JSON 或 YAML
- **文件命名**: `{profile_name}.json`

### 5.2 配置文件
- **存储位置**: `~/Library/Application Support/mHost/config.json`
- **内容包括**:
  - 应用偏好设置
  - 最后使用的 Profile
  - 窗口位置和大小
  - 主题设置

### 5.3 备份文件
- **存储位置**: `~/Library/Application Support/mHost/backups/`
- **命名规则**: `hosts_backup_{timestamp}.txt`
- **保留策略**: 最多保留 10 个备份文件

### 5.4 日志文件
- **存储位置**: `~/Library/Logs/mHost/`
- **文件类型**: 
  - `app.log` - 应用日志
  - `error.log` - 错误日志
  - `operation.log` - 操作历史

## 6. 错误处理需求

### 6.1 权限错误
- 检测权限不足情况
- 友好的权限请求提示
- 权限被拒绝时的降级处理

### 6.2 文件操作错误
- 文件不存在或无法访问
- 磁盘空间不足
- 文件被其他程序占用
- 网络驱动器访问问题

### 6.3 数据验证错误
- 无效的 IP 地址格式
- 无效的域名格式
- Profile 名称冲突
- 空或无效的配置文件

### 6.4 系统错误
- 系统 hosts 文件损坏
- 应用崩溃恢复
- 网络连接问题（如果涉及在线功能）

## 7. 用户体验需求

### 7.1 易用性
- 直观的用户界面
- 清晰的操作流程
- 智能的默认设置
- 快捷键支持

### 7.2 反馈机制
- 操作成功/失败提示
- 进度指示器
- 状态栏信息更新
- 音效反馈（可选）

### 7.3 帮助系统
- 内置使用说明
- 工具提示（Tooltip）
- 上下文帮助
- 常见问题解答

## 8. Helper Tool 权限管理方案

### 8.1 方案概述

为了提升用户体验，避免每次修改 hosts 文件时都需要输入管理员密码，mHost 采用 macOS Helper Tool 机制实现持久化权限管理。

### 8.2 技术实现

#### 8.2.1 Helper Tool 架构
```
mHost.app
├── 主应用程序（用户权限运行）
│   ├── UI 界面和业务逻辑
│   └── XPC 客户端
└── HostsHelper（特权 Helper Tool）
    ├── XPC 服务端
    ├── hosts 文件读写
    ├── 备份管理
    └── 操作日志
```

#### 8.2.2 工作流程
1. **首次启动检测**: 检查 Helper Tool 是否已安装
2. **权限请求**: 如未安装，显示权限说明并请求管理员授权
3. **Helper 安装**: 使用 `SMJobBless` 安装特权 Helper Tool
4. **XPC 通信**: 主应用通过 XPC 与 Helper Tool 通信
5. **文件操作**: Helper Tool 执行实际的 hosts 文件修改
6. **状态反馈**: 将操作结果返回给主应用

#### 8.2.3 安全机制
- **代码签名**: Helper Tool 必须正确签名
- **权限验证**: 验证调用方身份
- **参数校验**: 严格验证所有输入参数
- **操作审计**: 记录所有特权操作
- **最小权限**: Helper Tool 只能执行预定义操作

### 8.3 用户体验设计

#### 8.3.1 首次安装流程
1. **权限说明**: 清晰解释为什么需要管理员权限
2. **安装进度**: 显示 Helper Tool 安装进度
3. **安装结果**: 明确提示安装成功或失败
4. **降级处理**: 安装失败时提供传统授权模式

#### 8.3.2 日常使用体验
- **无感知操作**: Profile 切换无需额外授权
- **状态指示**: 显示 Helper Tool 运行状态
- **错误处理**: 友好的错误提示和恢复建议

### 8.4 管理功能

#### 8.4.1 Helper Tool 管理
- **状态查看**: 显示 Helper Tool 安装和运行状态
- **重新安装**: 支持重新安装损坏的 Helper Tool
- **卸载功能**: 提供完全卸载 Helper Tool 的选项
- **权限模式切换**: 允许用户选择权限管理模式

#### 8.4.2 故障排除
- **连接检测**: 检测 XPC 连接状态
- **权限诊断**: 诊断权限相关问题
- **日志查看**: 提供 Helper Tool 操作日志查看
- **手动修复**: 提供手动修复选项

### 8.5 实现优先级

#### 第一阶段（MVP）
- 实现传统的每次授权模式
- 基本的 hosts 文件操作功能
- 完整的 Profile 管理功能

#### 第二阶段（优化）
- 实现 Helper Tool 机制
- 添加持久化权限管理
- 优化用户体验流程

#### 第三阶段（完善）
- 完善错误处理和故障排除
- 添加高级管理功能
- 性能优化和稳定性提升

## 9. 扩展功能需求（可选）

### 9.1 高级功能
- Profile 分组管理
- 定时切换 Profile
- 网络环境自动检测切换
- Profile 同步（iCloud/网络）

### 9.2 集成功能
- 命令行工具支持
- AppleScript 支持
- 系统通知集成
- Dock 菜单快速切换

### 9.3 导入导出
- 从其他 host 管理工具导入
- 批量导入 CSV 格式
- 导出为不同格式
- Profile 模板功能

## 10. 开发计划

### 10.1 开发阶段

#### 阶段一：核心功能开发（2-3 周）
- Go 后端核心逻辑实现
- 基本的 Fyne UI 界面
- Profile 管理功能
- Host 文件读写功能

#### 阶段二：界面完善（1-2 周）
- 完整的用户界面实现
- 用户交互优化
- 错误处理完善
- 基本测试

#### 阶段三：功能增强（1-2 周）
- 权限管理优化
- 数据验证增强
- 日志系统实现
- 性能优化

#### 阶段四：测试和发布（1 周）
- 全面测试
- Bug 修复
- 文档完善
- 打包发布

### 10.2 技术风险
- macOS 权限管理复杂性
- Fyne 框架的学习曲线
- 系统文件操作的安全性
- 不同 macOS 版本的兼容性

### 10.3 成功标准
- 能够稳定运行在目标 macOS 版本上
- 成功管理和切换 host 配置
- 用户界面友好易用
- 无数据丢失或系统损坏风险
- 性能满足预期要求

## 11. 总结

mHost 项目旨在为 macOS 用户提供一个简单、安全、高效的 host 文件管理工具。通过 Go 语言的强大后端能力和 Fyne 的现代化 UI 框架，我们将创建一个既专业又易用的应用程序，满足开发者和高级用户对 host 文件管理的各种需求。